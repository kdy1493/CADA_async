<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <title>FastRTC Demo</title>
  <style>
    video { width: 60%; border: 2px solid #ccc; border-radius: 8px; }
  </style>
</head>
<body>
  <h2>스트림 테스트</h2>
  <video id="video_output_component_id" autoplay playsinline></video>

  <script>
    const pc = new RTCPeerConnection();
    const videoElem = document.getElementById("video_output_component_id");

    async function setupWebRTC(peer) {
      // 1) 로컬 카메라 가져와서 서버로 전송
      const localStream = await navigator.mediaDevices.getUserMedia({ video: true });
      localStream.getTracks().forEach(track => peer.addTrack(track, localStream));

      // 2) 서버에서 나오는 트랙 받기
      peer.addEventListener("track", ev => {
        if (videoElem.srcObject !== ev.streams[0]) {
          videoElem.srcObject = ev.streams[0];
        }
      });

      // 3) 데이터 채널 (필수)
      peer.createDataChannel("text");

      // 4) Offer 생성 및 로컬 설정
      const offer = await peer.createOffer();
      await peer.setLocalDescription(offer);

      // 고유 세션 ID
      const webrtc_id = Math.random().toString(36).slice(2);

      // 5) ICE 후보 대기 큐
      const pending = [];
      peer.onicecandidate = ({ candidate }) => {
        if (!candidate) return;
        if (!peer.currentRemoteDescription) {
          pending.push(candidate);
        } else {
          sendCandidate(candidate);
        }
      };

      // 6) Offer → 서버 (Answer 수신)
      const answer = await fetch("/webrtc/offer", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          type: offer.type,
          sdp: offer.sdp,
          webrtc_id: webrtc_id
        })
      }).then(res => res.json());
      await peer.setRemoteDescription(answer);

      // 7) 지연된 ICE 후보 전송
      pending.forEach(cand => sendCandidate(cand));

      // ICE 후보 전송 함수 (FastRTC가 파싱하는 형식)
      function sendCandidate(cand) {
        fetch("/webrtc/offer", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            type: "ice-candidate",
            webrtc_id: webrtc_id,
            candidate: cand.candidate,        // 문자열
            sdpMid: cand.sdpMid,
            sdpMLineIndex: cand.sdpMLineIndex
          })
        });
      }

      // ICE 상태 로그 (디버깅용)
      peer.addEventListener("iceconnectionstatechange", () => {
        console.log("ICE state:", peer.iceConnectionState);
      });
    }

    window.addEventListener("DOMContentLoaded", () => {
      setupWebRTC(pc).catch(console.error);
    });
  </script>
</body>
</html>
